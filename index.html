<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>INDOVP Demon List — Owner Mode</title>
<style>
  :root{--bg:#0f1720;--card:#111827;--accent:#2a6cf4;--ok:#22c55e;--bad:#ef4444;color:#e6eef6}
  body{background:var(--bg);color:var(--color,#e6eef6);font-family:Inter,Arial,Helvetica,sans-serif;padding:18px}
  h1{text-align:center;margin:6px 0 18px}
  .wrap{max-width:980px;margin:0 auto}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input[type="text"], input[type="number"], select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0b1220;color:var(--color);min-width:120px}
  button{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .card{background:var(--card);padding:12px;border-radius:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  .level-head{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .difficulty{padding:5px 8px;border-radius:6px;font-weight:700;color:#081223}
  .Easy{background:#34d399}
  .Medium{background:#60a5fa}
  .Hard{background:#fb923c}
  .Insane{background:#a78bfa}
  .Extreme{background:#f43f5e}
  .records{margin-top:10px}
  ul{list-style:none;padding:0;margin:0}
  li.record{display:flex;justify-content:space-between;padding:8px;border-radius:6px;background:rgba(255,255,255,0.02);margin-bottom:6px}
  .pending-bubble{background:#f59e0b;color:#081223;padding:4px 8px;border-radius:999px;font-weight:700}
  .owner-panel{margin-top:12px;padding:12px;border-radius:10px;background:rgba(42,108,244,0.06)}
  .muted{opacity:0.7;font-size:13px}
  .smallbtn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
  .approve{background:var(--ok);color:#021205}
  .reject{background:var(--bad);color:white}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .hint{font-size:13px;opacity:0.8}
</style>
</head>
<body>
<div class="wrap">
  <h1>INDOVP — Demon List mit Owner-Modus</h1>

  <div class="card">
    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
        <label class="muted">Owner-Code eingeben:</label>
        <input id="ownerCodeInput" type="text" placeholder="Code eingeben (z.B. 41342)">
        <button id="ownerLoginBtn">Login</button>
        <button id="ownerLogoutBtn" class="ghost" style="display:none">Logout</button>
      </div>
      <div class="right">
        <span id="ownerBadge" style="display:none" class="pending-bubble">Owner-Mode ON</span>
      </div>
    </div>
    <div class="muted">Gib <strong>41342</strong> ein, um Owner zu werden. Owner kann Pending-Runs prüfen & freigeben.</div>
  </div>

  <div id="levelsContainer"></div>

  <div id="ownerPanel" class="card owner-panel" style="display:none">
    <h3>Owner — Pending-Fach</h3>
    <div id="pendingList" style="min-height:40px"></div>
    <div class="hint">Pending-Runs sind noch nicht öffentlich — approve = landet unter dem Level, reject = weg.</div>
  </div>
</div>

<script>
/* ----- Konfiguration: Levels (hier deine eigenen Level eintragen) ----- */
const levels = [
  { id: 101, name: "Bloodrush", creator: "CreatorA", difficulty: "Insane" },
  { id: 102, name: "Skyfall", creator: "CreatorB", difficulty: "Hard" },
  { id: 103, name: "NeonGate", creator: "CreatorC", difficulty: "Extreme" },
  { id: 104, name: "EasyGrove", creator: "CreatorD", difficulty: "Easy" }
];
const DIFF_ORDER = ["Easy","Medium","Hard","Insane","Extreme"];

/* ----- Storage-Helper ----- */
function getPublicRecords(levelId){
  return JSON.parse(localStorage.getItem('records_'+levelId)) || [];
}
function savePublicRecord(levelId,record){
  const arr = getPublicRecords(levelId);
  arr.push(record);
  localStorage.setItem('records_'+levelId, JSON.stringify(arr));
}
function getPending(){
  return JSON.parse(localStorage.getItem('pending_runs')) || [];
}
function savePending(arr){
  localStorage.setItem('pending_runs', JSON.stringify(arr));
}
function addPending(levelId,record){
  const p = getPending();
  p.push({ levelId, record, ts: Date.now(), id: 'p'+Math.random().toString(36).slice(2,9) });
  savePending(p);
}

/* ----- Owner-Auth (Session) ----- */
const OWNER_CODE = "41342";
function isOwner(){
  return sessionStorage.getItem('isOwner') === '1';
}
function setOwner(flag){
  if(flag) sessionStorage.setItem('isOwner','1');
  else sessionStorage.removeItem('isOwner');
  updateOwnerUI();
}

/* ----- UI Rendering ----- */
const container = document.getElementById('levelsContainer');
function render(){
  container.innerHTML = '';
  // Sort levels by difficulty order
  const sorted = [...levels].sort((a,b)=>DIFF_ORDER.indexOf(a.difficulty)-DIFF_ORDER.indexOf(b.difficulty));
  sorted.forEach(lvl => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="level-head">
        <div>
          <div style="font-weight:800">${lvl.name}</div>
          <div class="muted">Creator: ${lvl.creator}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <div class="difficulty ${lvl.difficulty}">${lvl.difficulty}</div>
          <div class="muted" style="margin-top:6px">ID: ${lvl.id}</div>
        </div>
      </div>
      <div class="records">
        <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
          <div class="muted">Rekord einreichen:</div>
          <input type="text" id="name_${lvl.id}" placeholder="Dein Name">
          <input type="number" id="progress_${lvl.id}" placeholder="Prozent" min="0" max="100">
          <input type="number" id="attempts_${lvl.id}" placeholder="Versuche" min="1">
          <button onclick="handleSubmit(${lvl.id})">Einreichen</button>
        </div>
        <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
          <div class="muted">Öffentliche Rekorde</div>
          <div class="muted" style="margin-left:auto">Anzahl: <span id="pubcount_${lvl.id}">0</span></div>
        </div>
        <ul id="records_${lvl.id}" style="margin-top:8px"></ul>
      </div>
    `;
    container.appendChild(card);
    renderPublicRecords(lvl.id);
  });
  updateOwnerUI();
}

/* ----- Render öffentliche records für ein level ----- */
function renderPublicRecords(levelId){
  const ul = document.getElementById('records_'+levelId);
  if(!ul) return;
  const recs = getPublicRecords(levelId);
  ul.innerHTML = '';
  recs.forEach(r=>{
    const li = document.createElement('li');
    li.className = 'record';
    li.innerHTML = `<div>${escapeHTML(r.name)} — ${escapeHTML(r.progress)}% in ${escapeHTML(r.attempts)} tries</div>
                    <div class="muted">${new Date(r.ts).toLocaleString()}</div>`;
    ul.appendChild(li);
  });
  const cnt = document.getElementById('pubcount_'+levelId);
  if(cnt) cnt.textContent = recs.length;
}

/* ----- Submission Handler: landet in PENDING ----- */
function handleSubmit(levelId){
  const name = document.getElementById('name_'+levelId).value?.trim();
  const progress = document.getElementById('progress_'+levelId).value;
  const attempts = document.getElementById('attempts_'+levelId).value;
  if(!name || progress==='' || attempts===''){ alert('Bitte Name, Prozent und Versuche ausfüllen.'); return; }
  const record = { name, progress: Number(progress), attempts: Number(attempts), ts: Date.now() };
  // Save to pending (owner has to approve)
  addPending(levelId, record);
  // reset inputs
  document.getElementById('name_'+levelId).value='';
  document.getElementById('progress_'+levelId).value='';
  document.getElementById('attempts_'+levelId).value='';
  alert('Run eingereicht — wird dem Owner zur Prüfung vorgelegt.');
  renderPendingList();
}

/* ----- Owner UI & Pending List ----- */
const ownerPanel = document.getElementById('ownerPanel');
const pendingListEl = document.getElementById('pendingList');

function renderPendingList(){
  const pending = getPending();
  if(!isOwner()){
    pendingListEl.innerHTML = '<div class="muted">Du musst Owner sein, um Pending-Runs zu sehen.</div>';
    return;
  }
  if(pending.length===0){ pendingListEl.innerHTML = '<div class="muted">Keine Pending-Runs.</div>'; return; }
  pendingListEl.innerHTML = '';
  pending.forEach(item=>{
    const lvl = levels.find(x=>x.id===item.levelId) || {name:'Unknown', id:item.levelId};
    const wrap = document.createElement('div');
    wrap.style.display='flex';
    wrap.style.gap='8px';
    wrap.style.alignItems='center';
    wrap.style.marginBottom='8px';
    wrap.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:700">${escapeHTML(lvl.name)} <span class="muted">(#${lvl.id})</span></div>
        <div class="muted">${escapeHTML(item.record.name)} — ${escapeHTML(item.record.progress)}% in ${escapeHTML(item.record.attempts)} tries • ${new Date(item.record.ts).toLocaleString()}</div>
      </div>
    `;
    const btns = document.createElement('div');
    btns.style.display='flex'; btns.style.gap='6px';
    const approve = document.createElement('button'); approve.textContent='Approve'; approve.className='smallbtn approve';
    const reject = document.createElement('button'); reject.textContent='Reject'; reject.className='smallbtn reject';
    approve.onclick = ()=>{ approvePending(item.id); };
    reject.onclick = ()=>{ rejectPending(item.id); };
    btns.appendChild(approve); btns.appendChild(reject);
    wrap.appendChild(btns);
    pendingListEl.appendChild(wrap);
  });
}

function approvePending(pendingId){
  let pending = getPending();
  const idx = pending.findIndex(p=>p.id===pendingId);
  if(idx===-1){ alert('Pending nicht gefunden.'); renderPendingList(); return; }
  const item = pending[idx];
  // move to public
  savePublicRecord(item.levelId, { ...item.record, ts: Date.now() });
  // remove pending
  pending.splice(idx,1);
  savePending(pending);
  renderPendingList();
  renderPublicRecords(item.levelId);
}

function rejectPending(pendingId){
  let pending = getPending();
  const idx = pending.findIndex(p=>p.id===pendingId);
  if(idx===-1){ alert('Pending nicht gefunden.'); renderPendingList(); return; }
  // remove only
  pending.splice(idx,1);
  savePending(pending);
  renderPendingList();
}

/* ----- Owner Login UI ----- */
const ownerLoginBtn = document.getElementById('ownerLoginBtn');
const ownerLogoutBtn = document.getElementById('ownerLogoutBtn');
const ownerCodeInput = document.getElementById('ownerCodeInput');
const ownerBadge = document.getElementById('ownerBadge');

ownerLoginBtn.addEventListener('click', ()=>{
  const code = ownerCodeInput.value?.trim();
  if(code === OWNER_CODE){
    setOwner(true);
    ownerCodeInput.value='';
    alert('Owner-Login erfolgreich. Pending-Fach sichtbar.');
  } else {
    alert('Falscher Code.');
  }
});
ownerLogoutBtn.addEventListener('click', ()=>{ setOwner(false); alert('Owner-Logout.'); });

function updateOwnerUI(){
  if(isOwner()){
    ownerPanel.style.display = 'block';
    ownerBadge.style.display = 'inline-block';
    ownerLogoutBtn.style.display = 'inline-block';
    ownerLoginBtn.style.display = 'none';
    ownerCodeInput.style.display = 'none';
  } else {
    ownerPanel.style.display = 'none';
    ownerBadge.style.display = 'none';
    ownerLogoutBtn.style.display = 'none';
    ownerLoginBtn.style.display = 'inline-block';
    ownerCodeInput.style.display = 'inline-block';
  }
  renderPendingList();
}

/* ----- helpers ----- */
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ----- init ----- */
render();
renderPendingList();
updateOwnerUI();

</script>
</body>
</html>
